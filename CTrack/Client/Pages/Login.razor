@page "/login"
@inject HttpClient Http
@inject AuthenticationStateProvider authStateProvider
@inject ILocalStorageService localStorageService

<PageTitle >Login</PageTitle>

<h3>Login</h3>


<EditForm Model="user" OnSubmit="HandleLogin">
    <label for="username">email</label>
    <InputText id="username" @bind-Value="user.Email" />
    <label for="pw">password</label>
    <InputText id="pw" @bind-Value="user.Password" />
    <button type="submit" class="btn btn-primary"> Do It! </button>
</EditForm>

@if (IsLoading)
{
    <span> LOADING SPINNER AYAYAY </span>
}


@code {
    DTOUserLoginForm user = new DTOUserLoginForm();
    bool IsLoading { get; set; }

    async Task HandleLogin()
    {
        try
        {
            IsLoading = true;
            await Task.Yield();
            var result = await Http.PostAsJsonAsync("Auth/login", user);
            var token = await result.Content.ReadAsStringAsync();
            Console.WriteLine(token);
            await localStorageService.SetItemAsync("token", token);
            await authStateProvider.GetAuthenticationStateAsync();
        }
        catch(Exception e)
        {
            Console.WriteLine(e);
        }
        finally
        {
            IsLoading = false;
        }


        
    }
}
