@page "/login"
<PageTitle >Login</PageTitle>

<h3>Login</h3>


<EditForm Model="user" OnSubmit="HandleLogin">
    <label for="username">email</label>
    <InputText id="username" @bind-Value="user.Email" />
    <label for="pw">password</label>
    <InputText id="pw" @bind-Value="user.Password" />
    <button type="submit" class="btn btn-primary"> Do It! </button>
</EditForm>

<ClockSpinner IsLoading=@IsLoading SpinnerText="We are logging you in mate!" LoaderType="ClockSpinner.LoaderTypes.TwoBubbles"></ClockSpinner>

@code {
    [Inject] protected HttpClient Http { get; set; }
    [Inject] protected AuthenticationStateProvider authStateProvider { get; set; }
    [Inject] protected ILocalStorageService localStorageService { get; set; }
    [Inject] protected NavigationManager navigationmanager { get; set; }

    DTOUserLoginForm user = new DTOUserLoginForm();
    bool IsLoading { get; set; }

    async Task HandleLogin()
    {
        try
        {
            IsLoading = true;
            await Task.Yield();
            var result = await Http.PostAsJsonAsync("Auth/login", user);

            if (!result.IsSuccessStatusCode)
                throw new ArgumentException("Login Unsuccessful!");

            var token = await result.Content.ReadAsStringAsync();
            Console.WriteLine(token);
            await localStorageService.SetItemAsync("token", token);
            Console.WriteLine(await authStateProvider.GetAuthenticationStateAsync());
            navigationmanager.NavigateTo("/");
        }
        catch(Exception e)
        {
            Console.WriteLine(e);
        }
        finally
        {
            IsLoading = false;
        }
    }
}
